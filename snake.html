<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>A game where a snake comes out!!</title>
  <style>
    canvas {
      background: #111;
      display: block;
      margin: auto;
      max-width: 100%;
      height: auto;
    }

    body {
      background: #222;
      color: white;
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 10px;
    }

    h1 {
      font-size: 2rem;
      margin: 10px 0;
    }

    button {
      padding: 8px 16px;
      font-size: 1rem;
      margin: 5px;
      cursor: pointer;
      border-radius: 8px;
    }

    /* --- Mobile Controls (D-Pad) --- */
    #mobile-controls {
      display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏à‡∏≠‡πÉ‡∏´‡∏ç‡πà */
      width: 30vw;
      max-width: 140px;
      aspect-ratio: 1 / 1;
      margin: 20px auto;
      position: relative;
      border-radius: 50%;
      background: #333;
      border: 3px solid #666;
      user-select: none;
      touch-action: none;
    }

    @media (max-width: 768px) {
      #mobile-controls {
        display: block;
      }
      h1 {
        font-size: 1.5rem;
      }
      #score {
        font-size: 1rem;
      }
    }

    /* ‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á */
    .arrow {
      position: absolute;
      width: 25%;
      height: 25%;
      background: #444;
      color: white;
      border: 2px solid #666;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    #upBtn { top: 5%; left: 37%; }
    #downBtn { bottom: 5%; left: 37%; }
    #leftBtn { left: 5%; top: 37%; }
    #rightBtn { right: 5%; top: 37%; }

    /* Stars Rating */
    .star {
      font-size: 30px;
      cursor: pointer;
      color: gray;
      transition: transform 0.2s;
    }
    .star.selected {
      color: gold;
    }
    .star:hover {
      transform: scale(1.2);
    }
  </style>
</head>
<body>
  <h1>A game where a snake comes out!!</h1>
  <canvas id="gameCanvas" width="800" height="600"></canvas>
  <p id="status"></p>
  <p id="score">Score: 0</p>
  <button id="restartBtn" style="display:none">Play Again</button>

  <!-- D-Pad Controls -->
  <div id="mobile-controls">
    <div id="upBtn" class="arrow">‚Üë</div>
    <div id="downBtn" class="arrow">‚Üì</div>
    <div id="leftBtn" class="arrow">‚Üê</div>
    <div id="rightBtn" class="arrow">‚Üí</div>
  </div>

  <audio id="bgMusic" src="./sound/background.mp3" loop></audio>
  <audio id="eatSound" src="./sound/eatSound.mp3"></audio>
  <audio id="gameOverSound" src="./sound/gameover.mp3"></audio>

  <script>
    const snakeColors = [
      '#6b8e23', '#556b2f', '#808000', '#9acd32', '#adff2f'
    ];  

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const statusEl = document.getElementById("status");
    const scoreEl = document.getElementById("score");
    const restartBtn = document.getElementById("restartBtn");

    const bgMusic = document.getElementById("bgMusic");
    const eatSound = document.getElementById("eatSound");
    const gameOverSound = document.getElementById("gameOverSound");

    const headImg = new Image();
    headImg.src = "./images/headsnake.png"; // üî• ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏´‡∏±‡∏ô‡∏ã‡πâ‡∏≤‡∏¢

    const upBtn = document.getElementById("upBtn");
    const downBtn = document.getElementById("downBtn");
    const leftBtn = document.getElementById("leftBtn");
    const rightBtn = document.getElementById("rightBtn");

    // ‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö click + touch
    function bindControl(btn, newDir, opposite) {
      function handler() {
        if (direction !== opposite) nextDirection = newDir;
      }
      btn.addEventListener("click", handler);
      btn.addEventListener("touchstart", handler);
    }

    const tileSize = 20;
    const rows = canvas.height / tileSize;
    const cols = canvas.width / tileSize;

    let snake, direction, nextDirection, grow, gameOver, score, food, paused;
    let highScore = localStorage.getItem("highScore") || 0;
    let lastTime = 0; 
    let frameInterval = 100;

    function resizeCanvas() {
      let scale = Math.min(window.innerWidth / 800, window.innerHeight / 600);
      canvas.style.width = (800 * scale) + "px";
      canvas.style.height = (600 * scale) + "px";
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function resetGame() {
      snake = [{ x: 10, y: 10 }];
      direction = "right";
      nextDirection = "right";
      grow = false;
      gameOver = false;
      score = 0;
      frameInterval = 100;
      paused = false;
      food = generateFood();

      statusEl.textContent = "";
      updateScore();
      restartBtn.style.display = "none";

      bgMusic.pause();
      bgMusic.currentTime = 0;
      bgMusic.play();

      lastTime = 0;
      requestAnimationFrame(gameLoop);
    }

    function updateScore() {
      if (score > highScore) {
        highScore = score;
        localStorage.setItem("highScore", highScore);
      }
      scoreEl.textContent = "Score: " + score + " | High Score: " + highScore;
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowUp" && direction !== "down") nextDirection = "up";
      if (e.key === "ArrowDown" && direction !== "up") nextDirection = "down";
      if (e.key === "ArrowLeft" && direction !== "right") nextDirection = "left";
      if (e.key === "ArrowRight" && direction !== "left") nextDirection = "right";

      if (e.key === " ") {
        paused = !paused;
        statusEl.textContent = paused ? "Paused" : "";
        if (!paused) requestAnimationFrame(gameLoop);
      }
    });

    // ‚úÖ ‡πÉ‡∏ä‡πâ bindControl
    bindControl(upBtn, "up", "down");
    bindControl(downBtn, "down", "up");
    bindControl(leftBtn, "left", "right");
    bindControl(rightBtn, "right", "left");

    restartBtn.addEventListener("click", resetGame);

    document.body.addEventListener("click", () => {
      if (bgMusic.paused) bgMusic.play();
    }, { once: true });

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // ‡∏ß‡∏≤‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£
      ctx.fillStyle = "red";
      ctx.beginPath();
      ctx.arc(
        food.x * tileSize + tileSize / 2,
        food.y * tileSize + tileSize / 2,
        tileSize / 2 - 2,
        0,
        Math.PI * 2
      );
      ctx.fill();

      // ‡∏ß‡∏≤‡∏î‡∏á‡∏π
      snake.forEach((segment, index) => {
        if (index === 0) {
          const headSize = tileSize * 1.6;
          const headX = segment.x * tileSize + tileSize / 2;
          const headY = segment.y * tileSize + tileSize / 2;

          ctx.save();
          ctx.translate(headX, headY);

          let angle = 0;
          if (direction === "up") angle = -Math.PI / 2;
          if (direction === "down") angle = Math.PI / 2;
          if (direction === "left") angle = 0;
          if (direction === "right") angle = Math.PI;

          ctx.rotate(angle);
          ctx.drawImage(headImg, -headSize / 2, -headSize / 2, headSize, headSize);
          ctx.restore();
        } else {
          ctx.fillStyle = snakeColors[index % snakeColors.length];
          ctx.beginPath();
          ctx.arc(
            segment.x * tileSize + tileSize / 2,
            segment.y * tileSize + tileSize / 2,
            tileSize / 2 - 2,
            0,
            Math.PI * 2
          );
          ctx.fill();
        }
      });

      if (gameOver) {
        ctx.fillStyle = "rgba(0,0,0,0.5)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = "white";
        ctx.font = "30px Arial";
        ctx.textAlign = "center";
        ctx.fillText("GAME OVER", canvas.width / 2, canvas.height / 2 - 20);
        ctx.font = "20px Arial";
        ctx.fillText("Press Play Again", canvas.width / 2, canvas.height / 2 + 20);
      }
    }

    function update() {
      direction = nextDirection;
      const head = { ...snake[0] };

      if (direction === "up") head.y--;
      if (direction === "down") head.y++;
      if (direction === "left") head.x--;
      if (direction === "right") head.x++;

      if (
        head.x < 0 || head.x >= cols ||
        head.y < 0 || head.y >= rows ||
        snake.some(segment => segment.x === head.x && segment.y === head.y)
      ) {
        gameOverSound.play();
        gameOver = true;
        statusEl.textContent = "Game Over!";
        restartBtn.style.display = "inline-block";
        bgMusic.pause();
        return;
      }

      snake.unshift(head);

      if (head.x === food.x && head.y === food.y) {
        eatSound.play();
        score++;
        updateScore();

        if (frameInterval > 40) frameInterval -= 2;
        grow = true;
        food = generateFood();
      }

      if (!grow) snake.pop();
      else grow = false;
    }

    function generateFood() {
      let newFood;
      do {
        newFood = {
          x: Math.floor(Math.random() * cols),
          y: Math.floor(Math.random() * rows)
        };
      } while (snake.some(segment => segment.x === newFood.x && segment.y === newFood.y));
      return newFood;
    }

    function gameLoop(timestamp) {
      if (gameOver || paused) {
        draw();
        return;
      }

      if (timestamp - lastTime > frameInterval) {
        update();
        lastTime = timestamp;
      }

      draw();
      requestAnimationFrame(gameLoop);
    }

    resetGame();
  </script>

  <br>
  <a href="index.html">
    <button>Home</button>
  </a>

  <!-- Footer -->
  <footer style="margin-top:30px; padding:20px; background:#111; color:white;">
    <p id="visitorCount"></p>
    <div id="rating" style="margin-top:10px;">
      <span class="star" data-value="1">‚òÖ</span>
      <span class="star" data-value="2">‚òÖ</span>
      <span class="star" data-value="3">‚òÖ</span>
      <span class="star" data-value="4">‚òÖ</span>
      <span class="star" data-value="5">‚òÖ</span>
      <p id="ratingText" style="margin-top:5px; color:gold;"></p>
    </div>
  </footer>

  <script>
    // ---- Visitor Counter ----
    let count = localStorage.getItem("visitorCount") || 0;
    count++;
    localStorage.setItem("visitorCount", count);
    document.getElementById("visitorCount").textContent = "Visitors: " + count;

    // ---- Star Rating ----
    const stars = document.querySelectorAll(".star");
    const ratingText = document.getElementById("ratingText");
    let savedRating = localStorage.getItem("gameRating") || 0;

    function highlightStars(rating) {
      stars.forEach(star => {
        star.classList.remove("selected");
        if (star.dataset.value <= rating) {
          star.classList.add("selected");
        }
      });
      if (rating > 0) ratingText.textContent = "Rate this Game: " + rating + " Stars";
      else ratingText.textContent = "";
    }

    stars.forEach(star => {
      star.addEventListener("click", () => {
        let rating = star.dataset.value;
        localStorage.setItem("gameRating", rating);
        highlightStars(rating);
      });
    });

    if (savedRating > 0) highlightStars(savedRating);
  </script>
</body>
</html>
